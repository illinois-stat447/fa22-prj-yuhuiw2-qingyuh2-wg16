---
title: "Analysis"
author: "stat447"
date: '2022-12-02'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = F,warning = F)
```

## Loading Packages

```{r}
#Loading packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, car,sjPlot,gridExtra,factoextra,
               knitr,kableExtra,scales,fastDummies,cluster,
               GGally)
```

## Loading and tidying up the data

```{r}
##Import Full data
data <- read.csv("Crimes_-_2001_to_Present.csv")
## subset data for 2012 to 2022
data2012 <- data %>% filter(Year>2011)
## Extracting relevant variables
data2012 <- data2012 %>% 
  dplyr::select(Date,Primary.Type,Arrest,Domestic,Beat,
                District,Year,Community.Areas,Census.Tracts,
                Police.Beats)
```

## Checking structure of data

```{r}
glimpse(data2012)
```

## Checking Missing values

```{r}
## Over all missing values
sum(is.na(data2012))
## Checking missing values in each column
sapply(data2012, function (x) sum(is.na(x)))
# Missing Values are there in three columns (Community.Areas, Census.Tracts, Police.Beats)
## Replacing missing values with median (because its discrete data)
## Community Areas
data2012$Community.Areas <- ifelse(is.na(data2012$Community.Areas),
                                   median(data2012$Community.Areas,na.rm = T),
                                   data2012$Community.Areas)
## Census Tracts
data2012$Census.Tracts <- ifelse(is.na(data2012$Census.Tracts),
                                   median(data2012$Census.Tracts,na.rm = T),
                                   data2012$Census.Tracts)
## Police Beats
data2012$Police.Beats <- ifelse(is.na(data2012$Police.Beats),
                                   median(data2012$Police.Beats,na.rm = T),
                                   data2012$Police.Beats)
## remove any other missing value
data2012 <- na.omit(data2012)
## Checking missing values again for confirmation
sapply(data2012, function (x) sum(is.na(x)))
```

## Encoding and breaking categorical variables to dummies

```{r}
## Convert Arrest to dummy (True = 1, and False = 0)
data2012$Arrest <- ifelse(data2012$Arrest == "false",0,1)
## Convert Domestic to dummy (True = 1, and False = 0)
data2012$Domestic <- ifelse(data2012$Domestic == "false",0,1)
## Converting each "Primary.Type" categories to multiple dummies
## Merging some categories
data2012$Primary.Type[data2012$Primary.Type == "ASSAULT" |
                        data2012$Primary.Type == "CRIM SEXUAL ASSAULT" |
                        data2012$Primary.Type == "CRIMINAL SEXUAL ASSAULT"] <- "ASSAULT"
data2012$Primary.Type[data2012$Primary.Type == "NON-CRIMINAL" |
                      data2012$Primary.Type == "NON - CRIMINAL" |
                      data2012$Primary.Type == "NON-CRIMINAL (SUBJECT SPECIFIED)"] <- "NON_CRIMINAL"
data2012$Primary.Type[data2012$Primary.Type == "CONCEALED CARRY LICENSE VIOLATION" |
                      data2012$Primary.Type == "LIQUOR LAW VIOLATION" |
                      data2012$Primary.Type == "PUBLIC PEACE VIOLATION"|
                      data2012$Primary.Type == "OTHER NARCOTIC VIOLATION"|
                      data2012$Primary.Type == "INTERFERENCE WITH PUBLIC OFFICER"|
                      data2012$Primary.Type == "PUBLIC INDECENCY"|
                      data2012$Primary.Type == "RITUALISM"|
                      data2012$Primary.Type == "WEAPONS VIOLATION"] <- "VIOLATION"
data2012$Primary.Type[data2012$Primary.Type == "CRIMINAL DAMAGE" |
                      data2012$Primary.Type == "CRIMINAL TRESPASS"] <- "CRIMINAL"
data2012$Primary.Type[data2012$Primary.Type == "MOTOR VEHICLE THEFT" |
                      data2012$Primary.Type == "THEFT"] <- "THEFT"
data2012$Primary.Type[data2012$Primary.Type == "SEX OFFENSE" |
                      data2012$Primary.Type == "OTHER OFFENSE"|
                      data2012$Primary.Type == "OFFENSE INVOLVING CHILDREN" ] <- "OFFENSE"
# Creating dummies
data2012 <- data2012 %>% fastDummies::dummy_cols(select_columns = "Primary.Type")

```

## COnverting to Training and Testing for Classification

```{r}
## For reproducing
set.seed(100)
## Create train index for 80:20 split (Train = 80, Test = 20)
Index_train = sample(1:nrow(data2012), size = round(0.7*nrow(data2012)), replace=FALSE)
train_data = data2012[Index_train,]
test_data = data2012[-Index_train,]
```

## Check Train and Test data

```{r}
## Train data structure
glimpse(train_data)
## Test data structure
glimpse(test_data)
```

## K-Means Clustering

```{r}
## First there is need to scale data, to equalize magnitude
scaled_data <- data2012[,-c(1,2,6,7)]
## Correlation matrix
ggcorr(scaled_data,size=2,hjust=1,vjust=1)
```

# K Means 

```{r fig.align='center',fig.height=5,fig.width=6}
# Trying Kmeans with different number of K values
k2 <- kmeans(scaled_data, centers = 2, nstart = 25)
k3 <- kmeans(scaled_data, centers = 3, nstart = 25)
k4 <- kmeans(scaled_data, centers = 4, nstart = 25)
k5 <- kmeans(scaled_data, centers = 5, nstart = 25)
# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = scaled_data) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = scaled_data) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = scaled_data) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = scaled_data) + ggtitle("k = 5")
## Plot all Combine
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

We have tried different values of k from 2 to 5, and applied k-means on that data. We can see that almost all clusters are overlapping, but some of points in K = 2, are found to have many different points in different clusters.

## Checking outputs for K=2

```{r}
## Plot CLuster mean for each variable
clust_means <- as.data.frame(k2$centers) %>%
  pivot_longer(1:26,names_to = "Variable",values_to = "Cluster1 Mean") %>%
  mutate(`Cluster1 Mean`=round(`Cluster1 Mean`,3))
cbind.data.frame(clust_means[1:26,],`Cluster2 Mean`=clust_means$`Cluster1 Mean`[27:52])
```

## Comparing districts with clusters

```{r}
## Adding cluster variable in original data
data2012$cluster <- k2$cluster
## Comparing clusters with District
table(data2012$District,data2012$cluster)
```

